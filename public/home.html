<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=0">
    <title></title>
    <link rel="stylesheet" href="/pc/css/global.css">
    <link rel="icon" href="/favicon.gif">
    <script type="text/javascript" src="/pc/js/vue.min.js"></script>
    <script type="text/javascript" src="/pc/js/axios.min.js"></script>
    <script type="text/javascript" src="/pc/js/sweetalert.min.js"></script>
    <script type="text/javascript" src="/pc/js/encrypt.js"></script>

    <script type="text/javascript">
        let ua = navigator.userAgent;
        let ipad = ua.match(/(iPad).*OS\s([\d_]+)/),
            isIphone = !ipad && ua.match(/(iPhone\sOS)\s([\d_]+)/),
            isAndroid = ua.match(/(Android)\s+([\d.]+)/),
            isMobile = isIphone || isAndroid;


        // document.onselectstart = () => false;
        window.onbeforeunload = () => false;

        axios.defaults.headers.common['x_requested_with'] = 'XMLHttpRequest';

        function req(url, param = null, func) {
            if (!sessionStorage['token']){
                axios.get('/api.php/filelist').then(res => {
                    sessionStorage['token'] = res.headers.token;
                    req(url, param, func);
                });
            }else {
                let p = '';
                if (param) {
                    for (key of Object.keys(param)) {
                        p += `${key}=${param[key]}&`;
                    }
                }
                axios.post('/api.php/' + url, p, {
                    headers: {
                        'token': sessionStorage['token'],
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                }).then( res => {
                    if (res.data.err == 0) {
                        if (func) {
                            func(res.data.data, res.data);
                        }
                    }else {
                        if (res.data.err == 1005) {
                            sessionStorage.removeItem('token');
                            req(url, param, func);
                            return;
                        }
                        swal({
                            title: 'å¥½åƒå‡ºäº†ç‚¹é—®é¢˜å‘¢',
                            text: `${res.data.msg}:${res.data.err}`,
                            icon: 'error'
                        }).then( () => {
                            window.onbeforeunload = true;
                            sessionStorage.removeItem('token');
                            if (func) location.reload();
                        });
                        return false;
                    }
                });
            }
        }
        
        let verify = randomString();

	if (!isMobile) {
		document.body.css.fontFamily = 'å¾®è½¯é›…é»‘';
	}
    </script>
</head>

<body>
<div id="app">
    <div v-if="!isMobile" class="nav">
        <div onclick="location.reload()">{{ title }}</div>
        <input type="text" placeholder="æ–‡ä»¶/ç¬”è®°" @keypress.enter="search" v-model="s">
    </div>
    <div v-else>
        <div style="color: white;" ondblclick="location.reload()">æ°¸è¿œç›¸ä¿¡ï¼Œç¾å¥½çš„äº‹æƒ…å³å°†å‘ç”Ÿ</div>
    </div>

    <keep-live class="left">
        <component :is="page.left"></component>
    </keep-live>
    <keep-live class="right">
        <component :is="page.right"></component>
    </keep-live>

    <img style="display: none" src="/pc/img/file.png" alt="é¢„åŠ è½½å›¾æ ‡">
</div>
</body>

<template id="index">
    <div class="reduce">
        <!--{{ reduce }}-->
        <div class="detail">
            <img v-if="detail" @click="detail = null" src="/pc/img/back.png" alt="back" style="height: 25px;cursor: pointer;position: fixed">
            <div v-for="item in detail">
                <span v-html="item.issue.issue"></span>&emsp;
                <span style="color: grey" v-if="typeof item.issue.answer == 'object'">
                    <span v-for="i in item.issue.answer">{{ i }}ã€</span>
                </span>
                <span style="color: grey" v-else>{{ item.issue.answer }}</span>
            </div>
        </div>
        <span v-if="!detail">æ¬¢è¿å›æ¥ğŸ˜˜</span>
        <br>
        <span v-if="reduce && !detail" >
            æ‚¨åœ¨ <div class="record" v-for="item,key in reduce" :key="key" style="margin-bottom: 10px;">
                {{ item.time }}
                <span style="cursor: pointer" @click="details(item.data.sum)">åšäº†{{ (item.data.success? item.data.success.length: 0) + (item.data.error? item.data.error.length: 0) + (item.data.jump? item.data.jump.length: 0) }}ä¸ªé¢˜ç›®</span>ï¼Œ
                <span style="cursor: pointer" @click="details(item.data.success)" class="success">æ­£ç¡®{{ item.data.success? item.data.success.length: 0 }}ä¸ª</span>ï¼Œ
                <span style="cursor: pointer" @click="details(item.data.error)" class="error">é”™äº†{{ item.data.error? item.data.error.length: 0 }}ä¸ª</span>ï¼Œ
                <span style="cursor: pointer" @click="details(item.data.jump)" class="jump">è·³è¿‡äº†{{ item.data.jump? item.data.jump.length: 0 }}ä¸ª</span>ã€‚
                <br>
            </div>
        </span>
        <span v-else-if="!detail">æ­¤å¤„æš‚æ—¶æ²¡æœ‰ä»»ä½•è®°å½•å“¦...</span>
    </div>
</template>

<template id="home">
    <div class="st">
        <div class="title">{{ title }}</div>
        <ul class="progress" ref="progress">
            <!--<li @click="tab"> < </li>-->

            <li v-for="(item, key) in list" :key="key" v-if="item.issue" :title="item.issue.issue" :class="nav[key]">
                {{ key }}
            </li>

            <!--<li @click="tab"> > </li>-->
        </ul>
        <!-- ç­”é¢˜åŒºåŸŸ -->
        <div class="area">
            <!--{{ current }}-->
            <!-- è®¾è®¡æ˜¯æœ‰ä¸ªè¿™ä¸œè¥¿ï¼Œé‚£å°±æ¥ä¸€ä¸ªå§ -->
            <div class="title">
                {{ current.catalog || 'åˆ†ç±»è·å–å¤±è´¥' }}
            </div>
            <div class="issue" v-html="current.issue.issue || 'å†…å®¹è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯¹åº”çš„stæ–‡ä»¶'"></div>
            <div :class="{'hint': true, 'success': hint.success}">
                {{ hint.text }}
            </div>
            <!-- å›ç­”åŒºåŸŸ -->
            <div class="answer">
                <!-- å›ç­”é¢˜ -->
                <div v-if="current.issue.type == 'text'">
                    <textarea @keypress.enter.prevent="n()" v-model="answer"></textarea>
                </div>
                <!-- å•é€‰é¢˜ -->
                <div v-else-if="current.issue.type == 'radio'" :class="{'select':true, 'mobile-radio': isMobile}">
                    <div v-for="item,key in current.issue.item" :key="key">
                        <input name="radio" type="radio" :id="key" :value="item" v-model="answer">
                        <label class="radio" :for="key">{{ item }}</label>
                    </div>
                </div>
                <!-- å¤šé€‰é¢˜ -->
                <div v-else-if="current.issue.type == 'checkbox'" :class="{'select':true, 'mobile-radio': isMobile}">
                    <div v-for="item,key in current.issue.item" :key="key">
                        <input name="checkbox[]" type="checkbox" :id="key" :value="item" v-model="answer">
                        <label class="checkbox" :for="key">{{ item }}</label>
                    </div>
                </div>

                <div class="menu">
                    <button @click="n">ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="right-catalog">
    <div style="position: relative;">
        <ul class="catalog">
            <li v-for="(item,key) in path || catalog" :key="key" @click="enter(key)" :title="typeof item != 'string'? key: item">
                <span v-if="typeof item != 'string'">
                    <img src="/pc/img/dir.png" alt="dir">{{ key }}
                </span>
                <span v-else>
                    <img src="/pc/img/file.png" alt="file">
                    {{ item }}
                </span>
            </li>
        </ul>
        <div style="position: absolute;right: 15px;bottom: 10px;cursor: default">
            <span style="color: #8080801f;">by ccheng</span>
            <img src="/pc/img/back.png" alt="back" @click="back" style="height: 30px;cursor: pointer;">
        </div>
    </div>
</template>

<template id="right-analyze">
    <div class="tips">
        <div class="reduce">
            å·²ç­” {{ this.reduce.sum.length }} ä¸ªï¼š
            <div class="success">æ­£ç¡®ä¸ªæ•°: {{ this.reduce.success.length }}&emsp;( {{ Math.round(this.reduce.success.length / this.reduce.sum.length * 100) || 0 }}%    )</div>
            <div class="error">é”™è¯¯ä¸ªæ•°: {{ this.reduce.error.length }}&emsp;( {{ Math.round(this.reduce.error.length / this.reduce.sum.length * 100) || 0 }}% )</div>
            <div class="jump">è·³è¿‡ä¸ªæ•°: {{ this.reduce.jump.length }}&emsp;( {{ Math.round(this.reduce.jump.length / this.reduce.sum.length * 100) || 0 }}% )</div>
        </div>
        <div v-if="hint">
            å›ç­”é”™è¯¯(ã€ƒï¼ç›®ï¼œ)<br />
            æ­£ç¡®ç­”æ¡ˆæ˜¯:
            <div v-if="typeof current.issue.answer == 'object'">
                <span v-for="item in current.issue.answer">{{ item }}ã€</span>
            </div>
            <div v-else>{{ current.issue.answer }}</div>
        </div>
        <div v-if="prev_st" :class="{'analyze':!isMobile}">
            <hr style="border-bottom: 1px solid #ff5a5f7a;margin: 20px 3px 10px;">
            å‰é¢˜åˆ†æï¼š<br>
            {{ prev_st.catalog }} ä¸­çš„ {{ prev_st.title }}ï¼š
            <br>
            <span v-html="prev_st.declare">{{ prev_st.declare }}</span><br>
            <span v-if="prev_st.param"><br>
                å®ƒæœ‰{{ prev_st.param.length }}ä¸ªå¸¸ç”¨å‚æ•°ï¼š
                <span v-for="item in prev_st.param"><br>
                    <span style="color: #ff5a5f">{{ item.param }}</span>:
                    <span v-if="item.type">ç±»å‹ä¸º{{ item.type }}ã€‚</span>
                    {{ item.declare }}
                </span>
                <br>
            </span>
            <span v-if="prev_st.link"><br>
                å’Œå®ƒç±»ä¼¼çš„æœ‰&nbsp;
                <span v-for="item in prev_st.link">{{ item }}ã€</span>
                <br>
            </span>
            <span v-if="prev_st.return"><br>
                å®ƒçš„è¿”å›å€¼ä¸º
                <span v-if="prev_st.return.type"><span style="color: #ff5a5f">{{ prev_st.return.type }}ç±»å‹</span>ï¼Œ</span>
                {{ prev_st.return.declare }}
                <br>
            </span>
        </div>
    </div>
</template>

<script type="text/javascript">
    let eventBus = new Vue;

    new Vue({
        el: "#app",
        data: {
            title: 'æ°¸è¿œç›¸ä¿¡ï¼Œç¾å¥½çš„äº‹æƒ…å³å°†å‘ç”Ÿ',
            page: {
                left: 'index',
                right: 'right-catalog',
            },
            s: null
        },
        methods: {
            search() {
                if (this.s) {
                    window.open(`${location.origin}/search.html?s=` + new Base64().encode(JSON.stringify({'s':this.s})));
                    this.s = '';
                }
            }
        },
        created() {
            eventBus.$on('title', title => {
                this.title = title;
            });
            eventBus.$on('page-left', pl =>{
                this.page.left = pl;
            });
            eventBus.$on('page-right', pr =>{
                this.page.right = pr;
            });
        },
        components: {
            'index': {
                template: '#index',
                data() {
                    return {
                        reduce: {},
                        detail: null
                    }
                },
                methods: {
                    details(data) {
                        this.detail = data;
                        // console.log(this.detail);
                    }
                },
                created() {
                    req('/getReduce', {}, data => {
                        this.reduce = data;
                    });
                }
            },
            // ä¸»é¡µ
            'home': {
                template: '#home',
                data() {
                    return {
                        // å¯¼èˆª
                        nav: [],
                        // æ¦‚è§ˆï¼ˆåŒ…å«æ‰€æœ‰æµ‹è¯•é¢˜ç›®ï¼‰
                        list: null,
                        // å½“å‰è§£æ
                        current: null,
                        // å½“å‰ä½ç½®
                        index: 0,
                        // è¾“å…¥çš„å›ç­”
                        answer: [],
                        // å½“å‰æç¤º
                        hint: {text: null, success: false},
                        // æ ‡é¢˜
                        title: 'ä½ çš„é­”é¬¼æ¥äº†å“¦',
                    }
                },
                methods: {
                    start() {
                        req('/start/getTitle', {
                            file: sessionStorage.getItem('file'),
                        }, (data, d) => {
                            this.title = d.msg;
                        });
                        req('/start/getst', {
                            file: sessionStorage.getItem('file'),
                            param: isMobile? 2: 1
                        }, data => {
                            this.list = data;
                            this.n();
                        });
                    },
                    // è¿›å…¥ä¸‹ä¸€é¢˜
                    n() {
                        let verify = false;

                        if (!(verify = this.verify())){
                            this.nav[this.index - 1].error = true;
                            return false;
                        }

                        let next = this.list[this.index ++];

                        if (this.nav[this.index - 2]){
                            this.nav[this.index - 2].active = false;
                            if (verify && !this.nav[this.index - 2].error && !this.nav[this.index - 2].jump) {
                                this.nav[this.index - 2].success = true;
                            }else {
                                this.nav[this.index - 2].error = true;
                            }
                        }
                        this.nav[this.index - 1] = {active: true, success: null, error: null, jump: null};

                        if (next) {
                            if (next.issue.type == 'checkbox') this.answer = [];
                            else this.answer = null;

                            this.current = next;

                            eventBus.$emit('st_current', this.current, this.title);

                            // è¿›åº¦æ¡ä½ç½®å˜åŒ–
                            let gress = document.querySelector('li.active').offsetLeft;
                            if(this.$refs.progress && gress && this.$refs.progress.scrollLeft < gress) {
                                let interval = setInterval(() => {
                                    if (this.$refs.progress.scrollLeft < gress - 100)
                                        this.$refs.progress.scrollLeft = gress - 50;
                                    else if (this.$refs.progress.scrollLeft < gress)
                                        this.$refs.progress.scrollLeft += 3;
                                    else clearInterval(interval);
                                }, 10);
                                setTimeout(() => {
                                    clearInterval(interval);
                                }, 1000);
                            }
                        }else {
                            // å®Œæˆæ±‡æ€»
                            window.onbeforeunload = true;
                            swal({
                                title: "æç¤º",
                                text: "æ‚¨å·²ç»å®Œæˆäº†æ‰€æœ‰é¢˜ç›®ï¼Œæ‚¨ç°åœ¨å¯ä»¥åœ¨å³ä¾§æŸ¥çœ‹æ‚¨çš„æµ‹è¯•åˆ†æç»“æœï¼Œæ­¤æ¬¡ç»ƒä¹ è®°å½•å·²ç»ä¿å­˜Î¿(=â€¢Ï‰ï¼œ=)ÏâŒ’â˜†",
                                buttons: {
                                    cancel: true,
                                    confirm: true,
                                }
                            })
                            .then(res => {
                                if (res) location.reload();
                            });
                        }
                        return false;
                    },
                    verify() {
                        if (this.index <= 0) return 1;
                        if (this.answer) {
                            switch (this.current.issue.type) {
                                case 'text':
                                case 'radio':
                                    if (this.current.issue.answer == this.answer) {
                                        eventBus.$emit('hint', 'å›ç­”æ­£ç¡®äº†\\(0^â—‡^0)/', 0, this.index);
                                        return true;
                                    }else {
                                        eventBus.$emit('hint', 'æ‚¨çš„å›ç­”è²Œä¼¼ä¸æ­£ç¡®ï¼ï¹ï¼œ', 2, this.index);
                                    }
                                    break;
                                case 'checkbox':
                                    if (this.answer.length == this.current.issue.answer.length) {
                                        for (value of this.current.issue.answer) {
                                            if (!this.answer.includes(value)) {
                                                eventBus.$emit('hint', 'ä½ é€‰æ‹©çš„ç­”æ¡ˆä¸æ­£ç¡®å“¦(ãƒã¸ï¿£ã€)', 2, this.index);
                                                return false;
                                            }
                                        }
                                        eventBus.$emit('hint', 'ä½ çœŸæ£’Ïˆ(._. )>', 0, this.index);
                                        return true;
                                    }else if (!this.answer.length) {
                                        this.nav[this.index - 1].jump = true;
                                        eventBus.$emit('hint', 'æ‚¨è¿˜æ²¡æœ‰ä½œå›ç­”å‘¢(â—\'â—¡\'â—)', 1, this.index);
                                    }else {
                                        eventBus.$emit('hint', 'æ‚¨å‹¾é€‰çš„ç­”æ¡ˆæ•°é‡éƒ½å¯¹ä¸ä¸Šå‘¢(à¸‡ â€¢_â€¢)à¸‡', 2, this.index);
                                    }
                                    break;
                                default:
                                    eventBus.$emit('hint', 'è¿™ä¸ªç±»å‹æœ‰ç‚¹å¥‡æ€ªï¼Œæš‚æ—¶æ²¡æœ‰åŠæ³•è§£æå‘¢o((âŠ™ï¹âŠ™))o.');
                            }
                        }else {
                            this.nav[this.index - 1].jump = true;
                            eventBus.$emit('hint', 'æ‚¨è¿˜æ²¡æœ‰ä½œå›ç­”å‘¢(â—\'â—¡\'â—)', 1, this.index);
                        }
                        return false;
                    },
                    hintf(data, c) {
                        this.hint.text = data;
                        this.hint.success = c == 0;
                    }
                },
                mounted() {
                    this.start();
                    eventBus.$on('getst', this.start);
                    eventBus.$on('hint', this.hintf);
                    // è¿›å…¥çŠ¶æ€å§
                    window.onbeforeunload = false;
                    // console.clear();
                }
            },
            'right-analyze': {
                template: '#right-analyze',
                data() {
                    return {
                        // å’Œä¾§è¾¹æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¾ç¤ºä¸€ä¸‹ä¸åšæ”¹å˜
                        current: null,
                        prev_st: null,
                        title: null,
                        hint: false,
                        index: -1,
                        reduce: {success: [], error: [], jump: [], sum: []},
                    }
                },
                methods: {
                    stCurrent(data, title) {
                        this.prev_st = this.current; // å¯¹äºä¸Šä¸€é¢˜çš„åˆ†æï¼ŒåŠ å¼ºè®°å¿†
                        this.current = data;
                        this.title = title;
                    },
                    hintf(data, code, index) {
                        this.hint = code != 0;
                        if (code !== undefined && this.index != index) {
                            this.index = index;
                            if (this.hint) {
                                if (code == 1) { // è·³è¿‡çš„
                                    this.reduce.jump[this.reduce.jump.length] = this.current;
                                    req('/reduce/' + verify, {
                                        jump: JSON.stringify(this.current)
                                    });
                                }else if (code == 2) { // ç­”é”™çš„
                                    this.reduce.error[this.reduce.error.length] = this.current;
                                    req('/reduce/' + verify, {
                                        error: JSON.stringify(this.current)
                                    });
                                }
                            }else { // å›ç­”æ­£ç¡®çš„
                                this.reduce.success[this.reduce.success.length] = this.current;
                                req('/reduce/' + verify, {
                                    success: JSON.stringify(this.current)
                                });
                            }
                            this.reduce.sum[this.reduce.sum.length] = this.current;
                        }
                    },
                },
                mounted() {
                    eventBus.$on('st_current', this.stCurrent);
                    eventBus.$on('hint', this.hintf);
                }
            },
            'right-catalog': {
                template: '#right-catalog',
                data() {
                    return {
                        'catalog': null,
                        'path': null,
                    }
                },
                methods:{
                    enter(key){
                        let next = this.catalog[key];
                        if (typeof next != 'string'){
                            this.catalog = next;
                        }else {
                            sessionStorage.setItem('file', key);
                            eventBus.$emit('title', 'ç»ƒä¹ ');
                            eventBus.$emit('page-left', 'home');
                            eventBus.$emit('page-right', 'right-analyze');
                            eventBus.$emit('getst');
                        }
                    },
                    back() {
                        req('/filelist', {}, data => {
                            this.catalog = data;
                        });
                    }
                },
                mounted() {
                    this.back();
                }
            }
        }
    })
</script>
</html>
